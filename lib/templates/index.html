<html>
<head>
    <title>fmp - {{ playing.basename }}</title>
    <meta name="viewport" content="width=device-width, user-scalable=yes, target-densitydpi=device-dpi" />

    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.css" />
    <link rel="stylesheet" type="text/css" href="/static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
    
    <script type="text/javascript" src="/static/js/underscore-min.js"></script>
    <script type="text/javascript" src="/static/js/jquery.raty.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery-mousewheel.js"></script>
    <script src="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.js"></script>

</head>
<body>
    <span class='artist_title'>
        Playing:<span id="playing-file">{{ playing.get_artist_title() }}</span>
        <div class="float-right">
            <div id="time-status" class="float-right">-{{player.pos_data["left_str"]}} {{player.pos_data["pos_str"]}}/{{player.pos_data["dur_str"]}}</div>
            <br clear="left">
            <img id="album-art" src="" style="width: 100%; height: auto; float:right; max-width:100px;">
            <br clear="left">
        </div>
    </span>
    <br clear="left">

    <div class="float-left nowrap">
        <a class='action-link' href="?cmd=prev"><img src="/static/images/media-seek-backward.png"></a>
        {% if player.playingState == PLAYING %}
            <a class='action-link' href="?cmd=pause"><img id="play-pause-img" src="/static/images/media-playback-pause.png" border="0"></a>
        {% else %}
            <a class='action-link' href="?cmd=pause"><img id="play-pause-img" src="/static/images/media-playback-start.png" border="0"></a>
        {% endif %}
        
        <a class='action-link' href="?cmd=next"><img src="/static/images/media-seek-forward.png"></a>

        
    </div>
    
    <br clear="left">
    <input type="text" style="display:none; position:absolute; left:-10000;" id="junk-input">
    <table id="ratings-table" border="1" cellspacing="0">
        <tr>
            <td>User</td>
            <td>Rating</td>
            <td>True Score</td>
        </tr>
    </table>
    
    <label for="volume">Volume:</label>
    <input name="volume-slider-1"  data-theme="d" data-highlight="true" id="volume" min="0" max="100" step="1" value="{{ volume }}" type="range">
    

    <div class="float-right">
        <button data-inline="true" id="vol-minus">-</button>
        <button data-inline="true" id="vol-plus">+</button>
    </div>
    
    <br clear="all">

    <input name="seek-slider-1"  data-theme="d"  data-highlight="true" class="ui-hide-label" id="seek" min="0" max="{{ player.pos_data.dur_int }}" step="1" value="{{ player.pos_data.pos_int }}" type="range">
    <script type="text/html" id="tpl-rating">
        <tr class="user-line" data-uid="<%= uid %>">
            <td><%= uname %></td> 
            <td class="star-rating nowrap" data-rating="<%= rating %>" data-uid="<%= uid %>" ></td>
            <td><% print (Math.round(true_score,2)); %></td>
        </tr>
    </script>

    <script type="text/javascript">
        var change_lock = false;
            new_vol = [];
        
        $(document).ready(function(){
            $.fn.raty.defaults.path = '/static/images/raty/';
            var seek_lock = false,
                time_status = $("#time-status"),
                playing_file = $("#playing-file"),
                play_pause_img = $("#play-pause-img"),
                junk_input = $("#junk-input"),
                junk_input_parent = junk_input.parent(),
                player = {{ player.to_dict()|tojson|safe }},
                playing = {{ playing.to_dict()|tojson|safe }},
                ratings = {{ playing.to_dict()['ratings']|tojson|safe }},
                volume = {{ volume }},
                volume_lock = false,
                rating_tpl = _.template($("#tpl-rating").html()),
                ratings_table = $("#ratings-table"),
                $volume = $("#volume"),
                $seek = $("#seek"),
                $album_art = $("#album-art"),
                updates_per_second = 1,
                last_pos_str = "",
                last_left_str = "";
            junk_input_parent.hide();
            
            $(".action-link").click(function(evt) {
                if (evt) {
                    evt.preventDefault();
                }
                junk_input_parent.show();
                junk_input.show().focus().hide(); // The extents we must go to remove the border.
                // // console.log("target:",evt.currentTarget);
                junk_input_parent.hide();
                var href = evt.currentTarget.href;
                // console.log("evt",evt);
                if (href==undefined) {
                    href = $(evt.currentTarget).find("a").prop("href");
                }
                if (!href) {
                    return;
                }
                $.ajax(href+"&status=1",{"cache":false}).done(function(data){
                    // console.log("DATA:",data);
                    process_status(data);
                });
                return false;
            });

            
            function onRate(score, evt) {
                var uid = $(this).data("uid");
                if (!uid) {
                    return;
                }
                $.ajax({
                    "url":"/",
                    "data":{
                        "cmd": "rate",
                        "uid": uid,
                        "status":1,
                        "value":score,
                    }
                }).done(function(data){
                    process_status(data);
                });
            }

            function process_status(dta) {
                var player = dta.player;

                window.player = player;

                window.document.title = "fmp - " + dta.playing.basename;
                if (!_.isUndefined(dta.player.tags.image)) {
                    if (window.last_img != dta.player.tags.image) {
                        $album_art.prop('src', 'data:image/png;base64,'+dta.player.tags.image)
                                  .show();
                    }
                    window.last_img = dta.player.tags.image;
                } else {
                    $album_art.hide();
                    window.last_img = '';
                }
                
                
                /* 
                time_status.text("-" + player.pos_data["left_str"]+ " " + 
                                 player.pos_data["pos_str"]+"/"+player.pos_data["dur_str"]); */
                playing_file.text(dta.playing.artist_title);
                if (player.playingState != "PLAYING") {
                    play_pause_img.prop("src","/static/images/media-playback-start.png");
                } else {
                    play_pause_img.prop("src","/static/images/media-playback-pause.png");
                }

                if (window.volume != dta.volume) {
                    window.volume = dta.volume;
                    if (!volume_lock) {
                        volume_lock = true;
                        $volume.val(window.volume);
                        $volume.slider("refresh");
                        volume_lock = false;
                    }
                }

                seek_lock = true;
                $seek.val(dta.player.pos_data.pos_int);
                $seek.prop("max", dta.player.pos_data.dur_int);
                $seek.slider("refresh");
                seek_lock = false;

                if (window.ratings != dta.playing.ratings) {
                    window.ratings = dta.playing.ratings;

                    ratings_table.find(".user-line").remove();
                    var found = false;
                    for (var uid in dta.playing.ratings) {
                        var r = dta.playing.ratings[uid];
                        // // console.log("r:",r);
                        ratings_table.append(rating_tpl(r));
                        found = true;
                    }
                    
                    if (_.isEmpty(dta.playing.ratings) || !found) {
                        ratings_table.hide();
                        ratings_table.css("display","none");
                        // // console.log("hide");
                        return;
                    } else {
                        ratings_table.show();
                    }
                    $("td.star-rating").raty({
                        score: function () {
                            return $(this).data("rating")
                        },
                        click:onRate,
                        cancel: true,
                        cancelOff : 'cancel-off-big.png',
                        cancelOn  : 'cancel-on-big.png',
                        starHalf  : 'star-half-big.png',
                        starOff   : 'star-off-big.png',
                        starOn    : 'star-on-big.png',
                        size:24
                    });
                }
                
            }

            function format_time(nanosecnods) {
                var seconds = Math.floor(parseInt(nanosecnods) / 1000000000);
                var hrs = Math.floor(seconds / 3600);
                if (hrs) {
                    seconds = seconds - (hrs * 3600);
                }
                var minutes = Math.floor(seconds / 60);
                if (minutes) {
                    seconds = seconds - (minutes * 60);
                }
                var ret = "";
                if (hrs) {
                    ret = hrs+":";
                }

                minutes = Math.floor(minutes);
                if (minutes<=0) {
                    minutes = 0;
                }
                
                if (minutes < 10 && ret) {
                    minutes = "0"+minutes;
                }
                ret += minutes+":";

                seconds = Math.floor(seconds);
                if (seconds<=0) {
                    seconds = 0;
                }
                
                if (seconds < 10) {
                    seconds = "0"+seconds;
                }
                ret += ""+seconds;
                return ret;
            }

            function set_time() {
                if (!window.player) {
                    return;
                }
                if (window.player.playingState == "PLAYING") {
                    // 1000000000 = 1 second
                    var inc_by = 1000000000 / updates_per_second;
                    window.player.pos_data.left_int = parseInt(window.player.pos_data.left_int) - inc_by;
                    window.player.pos_data.pos_int =  parseInt(window.player.pos_data.pos_int) + inc_by;
                    window.player.pos_data["left_str"] = format_time(window.player.pos_data.left_int);
                    window.player.pos_data["pos_str"] = format_time(window.player.pos_data.pos_int);
                    if (last_pos_str != window.player.pos_data["pos_str"] && 
                        last_left_str != window.player.pos_data["left_str"]) {
                        last_pos_str = window.player.pos_data["pos_str"];
                        last_left_str = window.player.pos_data["left_str"];
                        time_status.text("-" + window.player.pos_data["left_str"]+ " " + 
                                         window.player.pos_data["pos_str"] + 
                                         "/" + window.player.pos_data["dur_str"]);
                    }
                    seek_lock = true;
                    $seek.val(window.player.pos_data.pos_int);
                    $seek.slider("refresh");
                    seek_lock = false;
                }
            }

            var get_status = function () {
                $.ajax("/status",{"cache":false}).done(function(data){
                    process_status(data);
                });
                return true
            }

            setInterval(get_status, 5000);
            setInterval(set_time, Math.floor(1000/updates_per_second));
            process_status({
                player:player,
                playing:playing,
                volume:volume
            });
            
            var change_volume = function(volume) {
                if (volume == undefined) {
                    return;
                }
                if (volume_lock) {
                    return;
                }
                volume_lock = true;
                volume_val = $volume.val();
                if (window.volume != volume) {
                    $.ajax({
                        "url":"/",
                        "data":{
                            "cmd": "vol",
                            "value":volume,
                            "status":1,
                        }
                    }).done(function(data){
                        process_status(data);
                    }).always(function(){
                        volume_lock = false;
                    });
                } else {
                    volume_lock = false;
                }
            }

            

            $volume.change(function () {
                if (volume_lock) {
                    return;
                }
                change_volume($volume.val());
                return true;
            });

            $seek.bind("change", function(){
                if (seek_lock) {
                    return;
                }
                seek_lock = true;
                var val = $(this).val();
                console.log("val:",val);
                window.player.pos_data.pos_int = parseInt(val);
                $.ajax({
                    "url":"/",
                    "data":{
                        "cmd": "seek_ns",
                        "value":val,
                        "status":1,
                    }
                }).done(function(data) {
                    val = parseInt(val);
                    window.player.pos_data.pos_int = val;
                    data.player.pos_data.pos_int = val;
                    process_status(data);
                    set_time();
                }).always(function(){
                    seek_lock = false;
                });
            });

            $("#seek").hide();

            $volume.parent(".ui-slider").on("mousewheel", function (evt, delta) {
                if (volume_lock) {
                    return;
                }
                // console.log("$volume.step:",$volume.step);
                // console.log("$volume.val():",$volume.val());
                // console.log("delta",delta);
                var step = parseInt($("#volume").prop("step"));
                if (delta == 1) {
                    // add to the val.
                    var new_val = parseInt($volume.val()) + step;
                    window.volume = -1;
                    $volume.val(new_val).slider("refresh");
                    change_volume(new_val);
                }
                if (delta == -1) {
                    // remove from the val
                    var new_val = parseInt($volume.val()) - step;
                    window.volume = -1;
                    $volume.val(new_val).slider("refresh");
                    change_volume(new_val);
                }
            });

            $seek.parent(".ui-slider").on("mousewheel", function (evt, delta) {
                if (seek_lock) {
                    return;
                }
                var step = 5000000000;
                if (delta == 1) {
                    // add to the val.
                    var new_val = parseInt($seek.val()) + step;
                    $seek.val(new_val).slider("refresh");
                }
                if (delta == -1) {
                    // remove from the val
                    var new_val = parseInt($seek.val()) - step;
                    $seek.val(new_val).slider("refresh");
                }
            });

            $("#vol-minus").click(function(){
                var step = parseInt($volume.prop("step"));
                var new_val = parseInt($volume.val()) - 5;
                window.volume = -1;
                $volume.val(new_val).slider("refresh");
                change_volume(new_val);
            });
            $("#vol-plus").click(function(){
                var step = parseInt($volume.prop("step"));
                var new_val = parseInt($volume.val()) + 5;
                window.volume = -1;
                $volume.val(new_val).slider("refresh");
                change_volume(new_val);
            });
            
            
            // get_status();
        });

    </script>
    
</body>
</html>
