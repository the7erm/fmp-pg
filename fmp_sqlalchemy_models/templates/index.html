{% include "header.html" ignore missing %}

<div data-role="page" data-theme="b">
    <div data-role="header" data-theme="b" data-position="fixed" style='text-align:center;'>
        <div style="padding:15px;">
            <span>FMP - </span>
            <span class='artist-title'>{{jukebox.playing.artist_title}}</span>
             - 
            <span class='time-status'>{{jukebox.player.pos_data['pos_str']}}</span>
        </div>
    </div>
    <div data-role="content">
        
    </div>
    <div data-role="footer" data-theme="b" data-position="fixed">
        <div data-role="controlgroup" data-type="horizontal" style="text-align:center;">
            <a class='player-control' href="/prev/" data-theme="c" data-role="button" data-mini="true" data-inline="true"><img src="/static/img/media-skip-backward.png"></a>
            <a class='player-control' href="/pause/" data-theme="c" data-role="button" data-mini="true" data-inline="true"><img class='playing-state-img' src="/static/img/media-playback-pause.png"></a>
            <a class='player-control' href="/next/" data-theme="c" data-role="button" data-mini="true" data-inline="true"><img src="/static/img/media-skip-forward.png"></a>
           
        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).bind("mobileinit", function () {
        var StatusModel = Backbone.DeepModel.extend({
                url: "/status/",
                idAttribute: "fid",
            }),
            pause_img = "/static/img/media-playback-pause.png",
            play_img = "/static/img/media-playback-start.png",
            conductor = new StatusModel(),
            on_change_title = function(){
                var artist_title = this.get('playing.artist_title') || 'failed',
                    pos_str = this.get('pos_data.pos_str') || 'failed',
                    title_string = "FMP - "+artist_title+" - "+pos_str;
                document.title = title_string;
                $('.artist-title').text(artist_title);
                $('.time-status').text(pos_str);
            },
            on_state_change = function(){
                var state = this.get('state') || 'STOPPED';
                if (state == 'PLAYING') {
                    $('.playing-state-img').attr('src', play_img);
                } else {
                    $('.playing-state-img').attr('src', pause_img);
                }
            };
        conductor.on("change:playing.artist_title", on_change_title);
        conductor.on("change:pos_data.pos_str", on_change_title);
        conductor.on("change:state", on_state_change);
        setInterval(function() {
            conductor.fetch();
            return true;
        }, 5000);
        conductor.fetch();
        nano_second =    1000000000;

        setInterval(function(){
            var pos = parseInt(conductor.get('pos_data.pos_int')) || 1;
            /*
            "dur_str": "3:54", 
            "dur_int": 234495000000, */
            pos += nano_second;
            conductor.set('pos_data.pos_int', pos);
            
            var seconds = Math.floor(pos / nano_second),
                minutes = Math.floor(seconds / 60),
                seconds = seconds % 60;
            if (seconds < 10) {
                seconds = "0"+seconds;
            }
            $('.time-status').text(minutes+":"+seconds);
            return true;
        }, 1000);

        $('.player-control').bind("tap", function(evt, ui){
            evt.preventDefault();
            
            $('.player-control').removeClass("ui-btn-active");
            $.ajax({
              url: this.href,
              dataType: 'json'
            }).done(function(data, textStatus, jqXHR){
                conductor.set(data);
            }).always(function(jqXHR, textStatus, errorThrown){
                $('.player-control').removeClass("ui-btn-active");
            });
        });
    });

</script>
<script src="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
{% include "footer.html" %}
