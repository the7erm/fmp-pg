<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" 
            href="//code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" ></link>
    <link rel="stylesheet" type="text/css"
          href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css"></link>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    
    
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
    <script src="/static/js/lib/deep-model.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <style>
        .player-control img {
            height: 30px;
            width: 30px;
        }
    </style>
</head>
<body>
<script type="text/javascript">
    $(document).bind("mobileinit", function () {
        var ConductorModel = Backbone.DeepModel.extend({
                url: "/status/",
                idAttribute: "fid",
                listenerLength: 0,
                initialize: function() {
                    Backbone.DeepModel.prototype.initialize.apply(this, arguments);
                    this.on("change:playing.listeners_ratings", this.checkListenersLength)
                },
                checkListenersLength: function() {
                    var listeners_ratings = this.get("playing.listeners_ratings") || [],
                        listeners_ratings_length = listeners_ratings.length;
                    if (this.listenerLength == listeners_ratings_length) {
                        return;
                    }
                    this.listenerLength = listeners_ratings_length;
                    this.trigger("change:playing.listeners_ratings.length");
                }
            }),
            pause_img = "/static/img/media-playback-pause.png",
            play_img = "/static/img/media-playback-start.png";
            window.conductor = new ConductorModel(); 
            on_change_title = function(){
                var artist_title = this.get('playing.artist_title') || 'failed',
                    title_string = "FMP - "+artist_title;
                document.title = title_string;
                $('.artist-title').text(artist_title);
            },
            on_change_time = function(){
                 var pos_str = this.get('pos_data.pos_str') || 'failed';
                 $('.time-status').text(pos_str);
            },
            on_state_change = function(){
                var state = this.get('state') || 'STOPPED';
                if (state == 'PLAYING') {
                    $('.playing-state-img').attr('src', play_img);
                } else {
                    $('.playing-state-img').attr('src', pause_img);
                }
            };
        conductor.on("change:playing.artist_title", on_change_title);
        conductor.on("change:pos_data.pos_str", on_change_time);
        conductor.on("change:state", on_state_change);
        setInterval(function() {
            conductor.fetch();
            return true;
        }, 5000);
        conductor.fetch();
        nano_second = 1000000000;

        setInterval(function(){
            var state = conductor.get('state');
            if (state != 'PLAYING') {
                return;
            }
            var pos = parseInt(conductor.get('pos_data.pos_int')) || 1;
            /*
            "dur_str": "3:54", 
            "dur_int": 234495000000, */

            pos += nano_second;
            conductor.set('pos_data.pos_int', pos);
            
            var seconds = Math.floor(pos / nano_second),
                minutes = Math.floor(seconds / 60),
                seconds = seconds % 60;
            if (seconds < 10) {
                seconds = "0"+seconds;
            }
            $('.time-status').text(minutes+":"+seconds);
            return true;
        }, 1000);

        $('.player-control').bind("tap", function(evt, ui){
            evt.preventDefault();
            
            $('.player-control').removeClass("ui-btn-active");
            $.ajax({
              url: this.href,
              dataType: 'json'
            }).done(function(data, textStatus, jqXHR){
                conductor.set(data);
            }).always(function(jqXHR, textStatus, errorThrown){
                $('.player-control').removeClass("ui-btn-active");
            });
        });
    });
</script>
<div data-role="page" data-theme="b">
    <div data-role="header" data-theme="b" data-position="fixed" style='text-align:center;'>
        <div style="padding:15px;">
            <span>FMP - </span>
            <span class='artist-title'>{{jukebox.playing.artist_title}}</span>
             - 
            <span class='time-status'>{{jukebox.player.pos_data['pos_str']}}</span>
        </div>
    </div>
    <div data-role="content">
        
