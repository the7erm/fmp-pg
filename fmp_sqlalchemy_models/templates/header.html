<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" 
            href="//code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" ></link>
    <link rel="stylesheet" type="text/css"
          href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css"></link>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
    <script src="/static/js/lib/deep-model.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <style>
        .player-control img {
            height: 25px;
            width: 25px;
        }
        .ui-panel-inner .player-control img {
            height: 15px;
            width: 15px;
        }

        .keyword {
            float:left;
            padding-top:3px;
            margin-right:2px;
            padding-bottom:3px;
            padding-right:5px;
            padding-left:5px;
        }
        a.keyword {
            text-overflow: ellipsis;
            max-width: 50%;
            overflow: hidden;
            font-size:0.75em;
            
        }
        div.containing-element .ui-slider-switch { 
            width: 6em;
        }
        .rating-6 {
            background-image: url(/static/img/rate.6.svg.png);
        }
        .rating-5 {
            background-image: url(/static/img/rate.5.svg.png);
        }
        .rating-4 {
            background-image: url(/static/img/rate.4.svg.png);
        }
        .rating-3 {
            background-image: url(/static/img/rate.3.svg.png);
        }
        .rating-2 {
            background-image: url(/static/img/rate.2.svg.png);
        }
        .rating-1 {
            background-image: url(/static/img/rate.1.svg.png);
        }
        .rating-0 {
            background-image: url(/static/img/rate.0.svg.png);
        }
        .rating {
            background-size:18px;
            background-repeat:no-repeat; 
            padding-left:25px;
            font-size: 16px;
            background-position:left; 
        }
        li.rating {
            background-position: 8px;
        }
        a.rating-button {
            padding:0;
            background-position: 15px;
            background-position: center;
        }

        .ui-panel.ui-panel-open {
            position:fixed;
        }
        .ui-panel-inner {
            position: absolute;
            top: 1px;
            left: 0;
            right: 0;
            bottom: 0px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        .containing-element {width: 30em;}

    </style>
</head>
<body>
<script id="#tpl-search-view" type="text/html">
<h1>Search results</h1>
</script>
<script type="text/javascript">
    $(document).bind("mobileinit", function () {
        $.mobile.ajaxEnabled = false;
        $.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;

        app = new AppRouter();
        Backbone.history.start();
        
        $.mobile.ajaxEnabled = false;
        var uids = [];
        _.each($("input.web-listeners:checked"), function(el){
            uids.push($(el).data('uid'))
        });
        var playerMode = {{ session.get("mode", "remote" )|tojson|safe }},
            webPlayerMode = {{ session.get("webPlayerMode", "multi" )|tojson|safe }},
            singleModeUid = {{ session.get("singleModeUid", playing.listeners_ratings[0].uid)|tojson|safe }};
        window.conductor = new ConductorModel({
            "mode": playerMode,
            "webPlayerMode": webPlayerMode,
            "singleModeUid": singleModeUid,
            "uids": uids
        });
        var playing_fid = {{ session.get("playing_fid", playing.fid )|safe }},
            resume = true;
        if (conductor.isRemoteMode()) {
            playing_fid = {{ playing.fid }};
            resume = false;
        }
        conductor.set({"playing.fid": playing_fid});
        $("#player-mode").find('option').each(function(i, el){
            console.log('conductor.get("mode")', conductor.get("mode"))
            var $el = $(el);
            if ($el.val() == conductor.get("mode")) {
                $el.prop('selected', true);
            } else {
                $el.prop('selected', false);
            }
        });

        window.webPlayer = new WebPlayerView({
            "el": "#js-player",
            'conductor': conductor,
            'fid': playing_fid,
            'resume': resume,
        }).render();
        var controlerView  = new ControllerView({
                "$els": $('.player-control'),
                "conductor": conductor, 
                "webPlayer": webPlayer
            }).render(),
            pause_img = "/static/img/media-playback-pause.png",
            play_img = "/static/img/media-playback-start.png";
            on_change_title = function(){
                var artist_title = this.get('playing.artist_title') || 'failed',
                    title_string = "FMP - "+artist_title;
                document.title = title_string;
                $('.playing-artist-title').text(artist_title);
            },
            on_change_time = function(){
                 var pos_str = this.get('pos_data.pos_str') || 'failed';
                 $('.playing-time-status').text(pos_str);
            },
            on_state_change = function(){
                var state = this.get('state') || 'STOPPED';
                if (state == 'PLAYING') {
                    $('.playing-state-img').attr('src', play_img);
                } else {
                    $('.playing-state-img').attr('src', pause_img);
                }
            };
        conductor.on("change:playing.artist_title", on_change_title);
        conductor.on("change:pos_data.pos_str", on_change_time);
        conductor.on("change:state", on_state_change);
        if (conductor.isRemoteMode()) {
            conductor.fetch();
        } else {
            
        }

        $(".web-listeners").bind("change", function(evt){
            var checked = evt.currentTarget.checked,
                uid = evt.currentTarget.dataset.uid;
            console.log("CHANGED:", checked, uid);
            if (typeof(webPlayer) != 'undefined') {
                var uids = conductor.get('uids') || [];
                if (checked) {
                    uids.push(uid);
                } else {
                    uids = _.without(uids, uid); 
                }
                conductor.set("uids", uids);
            }
            $.mobile.showPageLoadingMsg("a", "Selecting files ... ");
            $.ajax({
              url: "/listening/"+uid+"/"+checked,
              dataType: 'json',
              cache: false
            }).done(function(data, textStatus, jqXHR) {})
              .always(function(){
                    $.mobile.hidePageLoadingMsg();
            });
        });

        
        $("#web-player-mode").find('option[value="'+webPlayerMode+'"]').prop('selected', true);
        $("#web-player-mode").bind("change", function(evt){
            var webPlayerMode = this.value;
            conductor.set("webPlayerMode", this.value);
            displayListeningOptions();
        });
        
        $("#single-listener").find('option [value="'+singleModeUid+'"]').prop("selected", true);
        $("#single-listener").bind("change", function() {
            conductor.set("singleModeUid", this.value);
            var uids = conductor.get("uids");
            if (!_.contains(uids, this.value)) {
                console.log("CHECKING:", this.value);
                $("#checkbox-"+this.value).prop("checked", true).trigger("change");
            }
        });
        window.displayListeningOptions = function(){
            if (window.conductor.isRemoteMode()) {
                console.log("conductor is remote")
                $("#multi-listeners").show();
                $("#single-listener-div").hide();
                $("#web-player-mode-div").hide();
            } else {
                $("#web-player-mode-div").show();
                var webPlayerMode = window.conductor.get("webPlayerMode") || "multi";
                if (webPlayerMode == 'multi') {
                    $("#multi-listeners").show();
                    $("#single-listener-div").hide();
                } else {
                    $("#multi-listeners").hide();
                    $("#single-listener-div").show();
                }
            }
        }
        displayListeningOptions();

        conductor.on("change:playing.keywords", function(){
            var playing_keywords = $(".playing-keywords"),
                keywords = conductor.get("playing.keywords"),
                template = _.template("<a class='keyword ui-li-count ui-btn-up-c ui-btn-corner-all' href='#/search/<%= encodeURIComponent(word) %>'><%- word %></a>")
            playing_keywords.empty();
            _.each(keywords, function(v, k){
                // console.log("keyword:",v);
                playing_keywords.append(template(v));
            });
        });
    });
    $( document ).on( "pageinit", "#page", function() {
        $("#page").css("display", "");
        $( document ).on( "swipeleft swiperight", "#page", function( e ) {
            // We check if there is no open panel on the page because otherwise
            // a swipe to close the left panel would also open the right panel (and v.v.).
            // We do this by checking the data that the framework stores on the page element (panel: open).
            if ( $.mobile.activePage.jqmData( "panel" ) !== "open" ) {
                if ( e.type === "swipeleft"  ) {
                    $( "#right-panel" ).panel( "open" );
                } else if ( e.type === "swiperight" ) {
                    $( "#left-panel" ).panel( "open" );
                }
            }
        });
        
        $("#player-mode").on("change", function(evt) {
            var selected = $(evt.currentTarget).find("option:selected").val();
            if (selected == 'web') {
                // breakdown remote init web
                conductor.set("mode", "web");
                webPlayer.$el.show();
            } else {
                conductor.set("mode", "remote");
                webPlayer.$el.hide();
                // breakdown web init remote
            }
            conductor.initInterval();
            displayListeningOptions();
        });
        $("[data-role=header]").fixedtoolbar({ 
            tapToggleBlacklist: "a, button, input, select, textarea, .ui-header-fixed, .ui-footer-fixed, audio, video",
            transition: "none" });
        $("[data-role=footer]").fixedtoolbar({ tapToggleBlacklist: "a, button, input, select, textarea, .ui-header-fixed, .ui-footer-fixed, audio, video",
            transition: "none" });
    });
</script>
<div data-role="page" data-theme="b" id="page" style='display:none;'>
    <div data-role="header" data-theme="b" data-position="fixed">
        <a href="#left-panel" data-theme="b" data-icon="grid" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Open left panel</a>
        <a href="#right-panel" data-theme="b" data-icon="gear" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Open right panel</a>
        <div style='text-align:center; max-width:75%; margin:auto; padding:10px;'>
            <span>FMP - </span>
            <span class='playing-artist-title'>{{playing.artist_title}}</span>
             - 
            <span class='playing-time-status'>{{pos_data['pos_str']}}</span>
            
        </div>
    </div>
    <div data-role="content">
    <div id="js-player" style='width:100%;'></div>
