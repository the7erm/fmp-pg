<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" 
            href="//code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" ></link>
    <link rel="stylesheet" type="text/css"
          href="http://code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css"></link>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
    <script src="/static/js/lib/deep-model.min.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <style>
        .player-control img {
            height: 25px;
            width: 25px;
        }
        .ui-panel-inner .player-control img {
            height: 15px;
            width: 15px;
        }

        .keyword {
            float:left;
            padding-top:3px;
            margin-right:2px;
            padding-bottom:3px;
            padding-right:5px;
            padding-left:5px;
        }
        a.keyword {
            text-overflow: ellipsis;
            max-width: 50%;
            overflow: hidden;
            font-size:0.75em;
            
        }
        div.containing-element .ui-slider-switch { 
            width: 6em;
        }
    </style>
</head>
<body>
<script type="text/javascript">
    $(document).bind("mobileinit", function () {
        $.mobile.ajaxEnabled = false;
        var uids = [];
        _.each($("input.web-listeners:checked"), function(el){
            uids.push($(el).data('uid'))
        });
        var playerMode = readCookie("playerMode") || "remote";
        window.conductor = new ConductorModel({
            "mode": playerMode,
            "uids": uids
        });
        eraseCookie("playerMode");
        createCookie('playerMode', conductor.get("mode"), 365);
        $("#player-mode").find('option').each(function(i, el){
            console.log('conductor.get("mode")', conductor.get("mode"))
            var $el = $(el);
            if ($el.val() == conductor.get("mode")) {
                $el.prop('selected', true);
            } else {
                $el.prop('selected', false);
            }
        });
        window.webPlayer = new WebPlayerView({
            "el": "#js-player",
            'conductor': conductor,
            'fid': {{ playing.fid }},
            'resume': false,
        }).render();
        var controlerView  = new ControllerView({
                "$els": $('.player-control'),
                "conductor": conductor, 
                "webPlayer": webPlayer
            }).render(),
            pause_img = "/static/img/media-playback-pause.png",
            play_img = "/static/img/media-playback-start.png";
            on_change_title = function(){
                var artist_title = this.get('playing.artist_title') || 'failed',
                    title_string = "FMP - "+artist_title;
                document.title = title_string;
                $('.playing-artist-title').text(artist_title);
            },
            on_change_time = function(){
                 var pos_str = this.get('pos_data.pos_str') || 'failed';
                 $('.playing-time-status').text(pos_str);
            },
            on_state_change = function(){
                var state = this.get('state') || 'STOPPED';
                if (state == 'PLAYING') {
                    $('.playing-state-img').attr('src', play_img);
                } else {
                    $('.playing-state-img').attr('src', pause_img);
                }
            };
        conductor.on("change:playing.artist_title", on_change_title);
        conductor.on("change:pos_data.pos_str", on_change_time);
        conductor.on("change:state", on_state_change);
        conductor.fetch();

        $(".web-listeners").bind("change", function(evt){
            var checked = evt.currentTarget.checked,
                uid = evt.currentTarget.dataset.uid;
            console.log("CHANGED:", checked, uid);
            if (typeof(webPlayer) != 'undefined') {
                var uids = conductor.get('uids') || [];
                if (checked) {
                    uids.push(uid);
                } else {
                    uids = _.without(uids, uid); 
                }
                conductor.set("uids", uids);
            }
            $.ajax({
              url: "/listening/"+uid+"/"+checked,
              dataType: 'json',
              cache: false
            }).done(function(data, textStatus, jqXHR) {});
        });

        conductor.on("change:playing.keywords", function(){
            var playing_keywords = $(".playing-keywords"),
                keywords = conductor.get("playing.keywords"),
                template = _.template("<a class='keyword ui-li-count ui-btn-up-c ui-btn-corner-all' href='/search/?q=<%= encodeURIComponent(word) %>'><%- word %></a>")
            playing_keywords.empty();
            _.each(keywords, function(v, k){
                // console.log("keyword:",v);
                playing_keywords.append(template(v));
            });
        });
    });
    $( document ).on( "pageinit", "#page", function() {
        $( document ).on( "swipeleft swiperight", "#page", function( e ) {
            // We check if there is no open panel on the page because otherwise
            // a swipe to close the left panel would also open the right panel (and v.v.).
            // We do this by checking the data that the framework stores on the page element (panel: open).
            if ( $.mobile.activePage.jqmData( "panel" ) !== "open" ) {
                if ( e.type === "swipeleft"  ) {
                    $( "#right-panel" ).panel( "open" );
                } else if ( e.type === "swiperight" ) {
                    $( "#left-panel" ).panel( "open" );
                }
            }
        });
        
        $("#player-mode").on("change", function(evt) {
            var selected = $(evt.currentTarget).find("option:selected").val();
            if (selected == 'web') {
                // breakdown remote init web
                conductor.set("mode", "web");
                webPlayer.$el.show();
            } else {
                conductor.set("mode", "remote");
                webPlayer.$el.hide();
                // breakdown web init remote
            }
            conductor.initInterval();
        });
    });
</script>
<div data-role="page" data-theme="b" id="page">
    <div data-role="header" data-theme="b" data-position="fixed">
        <a href="#left-panel" data-theme="b" data-icon="grid" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Open left panel</a>
        <a href="#right-panel" data-theme="b" data-icon="gear" data-iconpos="notext" data-shadow="false" data-iconshadow="false">Open right panel</a>
        <div style='text-align:center; max-width:75%; margin:auto; padding:10px;'>
            <span>FMP - </span>
            <span class='playing-artist-title'>{{playing.artist_title}}</span>
             - 
            <span class='playing-time-status'>{{pos_data['pos_str']}}</span>
            
        </div>
    </div>
    <div data-role="content">
    <div id="js-player" style='width:100%;'></div>
